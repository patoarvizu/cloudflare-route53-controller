version: 2.1

jobs:
  build:
    working_directory: /home/circleci/go/src/github.com/patoarvizu/cloudflare-route53-controller
    docker:
      - image: docker:18.09-git
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Build and push image
          command: |
            echo $DOCKER_HUB_KEY | docker login -u $DOCKER_HUB_USER --password-stdin
            docker build -f docker/Dockerfile -t patoarvizu/cloudflare-route53-controller:$CIRCLE_SHA1 .
            VERSION=${CIRCLE_TAG:-latest}
            docker tag patoarvizu/cloudflare-route53-controller:$CIRCLE_SHA1 patoarvizu/cloudflare-route53-controller:latest
            docker tag patoarvizu/cloudflare-route53-controller:$CIRCLE_SHA1 patoarvizu/cloudflare-route53-controller:$VERSION
            docker push patoarvizu/cloudflare-route53-controller:$CIRCLE_SHA1
            docker push patoarvizu/cloudflare-route53-controller:$VERSION
            docker push patoarvizu/cloudflare-route53-controller:latest

workflows:
  version: 2
  build-controller:
    jobs:
      - build:
          filters:
            tags:
              only: /^v\d+\.\d+.\d+$/